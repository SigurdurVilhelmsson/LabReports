# Deployment Setup Guide - LabReports Monorepo

This guide explains the proper deployment structure for the LabReports application, which contains both frontend and backend in a single repository.

---

## Repository Structure

The LabReports repository is a **monorepo** containing:

```
LabReports/ (single git repository)
├── src/              # Frontend source (React + TypeScript)
├── server/           # Backend source (Node.js + Express)
│   ├── index.js      # Main server file
│   ├── .env          # Backend environment variables (NOT in git)
│   └── README.md     # Backend documentation
├── dist/             # Frontend build output (generated by npm run build)
├── public/           # Static assets
├── package.json      # Shared dependencies
├── vite.config.ts    # Frontend build config
└── .env              # Frontend environment variables (NOT in git)
```

**Important**: This is **ONE repository**, not separate frontend and backend repos.

---

## Deployment Architecture

### Option A: Single Location Deployment (Recommended)

Deploy the entire repository to one location and run both services from there.

#### Directory Structure

```
Server Filesystem:
/var/www/kvenno.app/
├── LabReports/                  # Full git repo deployed here
│   ├── .git/                    # Git repository
│   ├── src/                     # Frontend source
│   ├── server/                  # Backend source
│   │   ├── index.js             # Backend entry point
│   │   └── .env                 # Backend secrets (create manually)
│   ├── dist/                    # Frontend build output
│   ├── package.json
│   └── .env                     # Frontend config (optional, for builds)
│
├── 2-ar/                        # Symlink or separate build
│   └── lab-reports/ -> ../../LabReports/dist/
│
└── 3-ar/                        # Symlink or separate build
    └── lab-reports/ -> ../../LabReports/dist/
```

#### Deployment Steps

```bash
# 1. Clone repository to server
cd /var/www/kvenno.app/
git clone https://github.com/SigurdurVilhelmsson/LabReports.git

# 2. Install dependencies
cd LabReports
npm install

# 3. Create backend .env file
cd server
cat > .env << 'EOF'
CLAUDE_API_KEY=sk-ant-your-actual-key-here
PORT=8000
NODE_ENV=production
FRONTEND_URL=https://kvenno.app
EOF

# 4. Build frontend
cd /var/www/kvenno.app/LabReports
npm run build

# 5. Create symlinks for year-specific deployments (if needed)
mkdir -p /var/www/kvenno.app/2-ar
ln -s /var/www/kvenno.app/LabReports/dist /var/www/kvenno.app/2-ar/lab-reports

mkdir -p /var/www/kvenno.app/3-ar
ln -s /var/www/kvenno.app/LabReports/dist /var/www/kvenno.app/3-ar/lab-reports

# 6. Setup systemd service for backend
sudo nano /etc/systemd/system/kvenno-backend.service
```

#### systemd Service Configuration

```ini
[Unit]
Description=Kvenno Lab Reports Backend API
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/kvenno.app/LabReports/server
ExecStart=/usr/bin/node index.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=kvenno-backend

# Environment variables (or use EnvironmentFile=/var/www/kvenno.app/LabReports/server/.env)
Environment="NODE_ENV=production"
Environment="PORT=8000"

[Install]
WantedBy=multi-user.target
```

```bash
# Enable and start service
sudo systemctl daemon-reload
sudo systemctl enable kvenno-backend
sudo systemctl start kvenno-backend
sudo systemctl status kvenno-backend
```

---

### Option B: Multiple Deployment Locations

Deploy the repository to multiple locations for separate frontend instances with a shared backend.

#### Directory Structure

```
/var/www/kvenno.app/
├── backend/                     # Full git repo deployed here (for backend)
│   ├── .git/
│   ├── server/
│   │   ├── index.js
│   │   └── .env                 # Backend secrets
│   └── package.json
│
├── 2-ar/
│   └── lab-reports/             # Separate git clone + build (or copy of dist/)
│       ├── index.html
│       ├── assets/
│       └── ...
│
└── 3-ar/
    └── lab-reports/             # Separate git clone + build (or copy of dist/)
        ├── index.html
        ├── assets/
        └── ...
```

#### Deployment Steps

```bash
# 1. Deploy backend
cd /var/www/kvenno.app/
git clone https://github.com/SigurdurVilhelmsson/LabReports.git backend
cd backend
npm install
cd server
cat > .env << 'EOF'
CLAUDE_API_KEY=sk-ant-your-key
PORT=8000
NODE_ENV=production
FRONTEND_URL=https://kvenno.app
EOF

# 2. Deploy frontend for 2nd year
mkdir -p /var/www/kvenno.app/2-ar
cd /var/www/kvenno.app/2-ar
git clone https://github.com/SigurdurVilhelmsson/LabReports.git lab-reports-src
cd lab-reports-src
npm install

# Create frontend .env
cat > .env << 'EOF'
VITE_API_ENDPOINT=https://kvenno.app/api
VITE_BASE_PATH=/2-ar/lab-reports
VITE_APP_MODE=dual
EOF

npm run build
mv dist ../lab-reports
cd ..
rm -rf lab-reports-src  # Remove source after build

# 3. Deploy frontend for 3rd year (similar process)
# ... repeat with VITE_BASE_PATH=/3-ar/lab-reports
```

**Drawback**: Each deployment requires separate git pulls and builds.

---

## Recommended Approach for Your Setup

Based on your workflow, I recommend **Option A with a slight modification**:

### Hybrid Approach

```
/home/user/repos/LabReports/     # Development repo (your local work)
    ├── .git/
    ├── src/
    ├── server/
    └── ...

/var/www/kvenno.app/LabReports/  # Production deployment
    ├── .git/                     # Can pull updates
    ├── server/                   # Backend runs from here
    │   ├── index.js
    │   └── .env                  # Production secrets
    ├── dist/                     # Frontend builds here
    └── ...
```

**Workflow**:

```bash
# On your development machine (or server via SSH to ~/repos/)
cd ~/repos/LabReports
git pull origin main  # or specific branch
npm install
npm run build

# Deploy to production
sudo rsync -av ~/repos/LabReports/dist/ /var/www/kvenno.app/LabReports/dist/
sudo rsync -av ~/repos/LabReports/server/ /var/www/kvenno.app/LabReports/server/ --exclude=.env

# OR, deploy via git pull in production directory
cd /var/www/kvenno.app/LabReports
git pull origin main
npm install  # If package.json changed
npm run build
sudo systemctl restart kvenno-backend
```

---

## Updating After Code Changes

### Quick Update (Recommended)

```bash
# 1. Pull latest code
cd /var/www/kvenno.app/LabReports
git fetch origin
git checkout <branch-name>  # e.g., claude/fix-docx-pdf-consistency-...
git pull

# 2. Install dependencies (if package.json changed)
npm install

# 3. Rebuild frontend (if frontend code changed)
npm run build

# 4. Restart backend (if backend code changed)
sudo systemctl restart kvenno-backend

# 5. Verify
sudo systemctl status kvenno-backend
```

### Update Specific Component

**Frontend only**:
```bash
cd /var/www/kvenno.app/LabReports
git pull
npm run build
# No need to restart backend
```

**Backend only**:
```bash
cd /var/www/kvenno.app/LabReports
git pull
sudo systemctl restart kvenno-backend
# No need to rebuild frontend
```

---

## Current Issue Resolution

Based on your message, it sounds like you have:

- ✅ `/home/user/repos/LabReports/` - Full repo with git
- ❌ `/var/www/kvenno.app/backend/` - Directory without git repo

**Problem**: The backend directory is not a git repository, so you can't `git pull` there.

### Solution 1: Make Backend a Full Repo Clone

```bash
# Remove current backend directory (backup first!)
cd /var/www/kvenno.app
sudo mv backend backend.backup

# Clone the full repo as backend
sudo git clone https://github.com/SigurdurVilhelmsson/LabReports.git backend

# Restore .env file
sudo cp backend.backup/server/.env backend/server/.env

# Install dependencies
cd backend
sudo npm install

# Restart backend
sudo systemctl restart kvenno-backend
```

### Solution 2: Use Your Dev Repo for Production

```bash
# Use your existing ~/repos/LabReports as the production location
# Change systemd service to point to your repo

sudo nano /etc/systemd/system/kvenno-backend.service

# Change WorkingDirectory to:
WorkingDirectory=/home/user/repos/LabReports/server

sudo systemctl daemon-reload
sudo systemctl restart kvenno-backend
```

### Solution 3: Symlink Backend

```bash
# Make backend a symlink to your full repo
cd /var/www/kvenno.app
sudo rm -rf backend
sudo ln -s /home/user/repos/LabReports backend

# Backend will now be at /var/www/kvenno.app/backend/server/
# Update systemd WorkingDirectory accordingly
```

---

## Environment Variables

### Backend (.env location)

**File**: `/var/www/kvenno.app/LabReports/server/.env` (or wherever backend is deployed)

```bash
CLAUDE_API_KEY=sk-ant-your-actual-key
PORT=8000
NODE_ENV=production
FRONTEND_URL=https://kvenno.app
```

**CRITICAL**: This file should **NEVER** be committed to git. Keep it secret!

### Frontend (.env location)

**File**: `/var/www/kvenno.app/LabReports/.env` (only needed during build)

```bash
VITE_API_ENDPOINT=https://kvenno.app/api
VITE_BASE_PATH=/2-ar/lab-reports
VITE_APP_MODE=dual
```

This is compiled into the frontend build and doesn't need to exist in production after build.

---

## Troubleshooting

### "Not a git repository" Error

**Cause**: The directory is not a git clone.

**Fix**: Clone the repository to that location:
```bash
cd /var/www/kvenno.app
sudo git clone https://github.com/SigurdurVilhelmsson/LabReports.git backend
```

### Backend Not Finding Dependencies

**Cause**: `npm install` not run after deployment.

**Fix**:
```bash
cd /var/www/kvenno.app/LabReports  # or wherever repo is
npm install
sudo systemctl restart kvenno-backend
```

### Frontend Not Updating

**Cause**: Build not run after code changes.

**Fix**:
```bash
cd /var/www/kvenno.app/LabReports
npm run build
# nginx serves the updated dist/ directory
```

### Service Won't Start

**Cause**: Wrong WorkingDirectory in systemd service, or .env file missing.

**Fix**:
```bash
# Check service configuration
sudo systemctl cat kvenno-backend

# Verify paths
ls -la /var/www/kvenno.app/LabReports/server/index.js
ls -la /var/www/kvenno.app/LabReports/server/.env

# Check logs
sudo journalctl -u kvenno-backend -n 50 --no-pager
```

---

## Recommended Final Setup

Here's what I recommend for your situation:

```bash
# 1. Use your existing development repo as production source
cd /home/user/repos/LabReports

# 2. Create backend symlink
cd /var/www/kvenno.app
sudo rm -rf backend
sudo ln -s /home/user/repos/LabReports backend

# 3. Update systemd service
sudo nano /etc/systemd/system/kvenno-backend.service
# Set: WorkingDirectory=/home/user/repos/LabReports/server

# 4. Reload and restart
sudo systemctl daemon-reload
sudo systemctl restart kvenno-backend

# 5. Build frontend
cd /home/user/repos/LabReports
npm run build

# 6. Deploy frontend (copy or symlink dist/)
sudo mkdir -p /var/www/kvenno.app/2-ar/lab-reports
sudo rsync -av dist/ /var/www/kvenno.app/2-ar/lab-reports/
```

Now when you need to update:
```bash
cd /home/user/repos/LabReports
git pull origin <branch>
npm install
npm run build
sudo systemctl restart kvenno-backend
sudo rsync -av dist/ /var/www/kvenno.app/2-ar/lab-reports/
```

---

## Questions to Clarify

Before proceeding, please clarify:

1. **Where is your backend currently running from?**
   - `/var/www/kvenno.app/backend/server/index.js`?
   - `/home/user/repos/LabReports/server/index.js`?
   - Somewhere else?

2. **Where is your frontend currently served from?**
   - `/var/www/kvenno.app/2-ar/lab-reports/`?
   - `/var/www/kvenno.app/LabReports/dist/`?

3. **What is your preferred workflow?**
   - Develop in `~/repos/`, deploy by copying to `/var/www/`?
   - Develop in `~/repos/`, deploy by symlinking?
   - Pull directly to `/var/www/` for production updates?

Once I know your current setup, I can provide the exact commands to fix the deployment structure.

---

**Last Updated**: 2025-11-28
